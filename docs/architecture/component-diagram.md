# 母婴商城组件交互图

## 概述

本文档详细描述了母婴商城系统中各个组件之间的交互关系，包括数据流向和通信方式。组件交互图有助于理解系统内部的协作机制和依赖关系，为开发和维护提供参考。

## 组件交互图

![组件交互图](./diagrams/component-diagram.png)

## 核心组件交互说明

### 1. 用户认证与授权流程

```
客户端 -> API网关 -> 认证控制器 -> 安全服务 -> 用户服务 -> 数据库
                                 -> Token生成服务 -> Redis缓存
```

- **交互说明**:
  1. 客户端提交用户名和密码到API网关
  2. API网关转发请求到认证控制器
  3. 认证控制器调用安全服务进行身份验证
  4. 安全服务通过用户服务查询数据库验证用户信息
  5. 验证成功后，安全服务调用Token生成服务生成JWT令牌
  6. Token相关信息存储到Redis缓存中
  7. 令牌返回给客户端

### 2. 商品搜索流程

```
客户端 -> API网关 -> 搜索控制器 -> 搜索服务 -> Elasticsearch
                               -> 商品服务 -> MySQL数据库
```

- **交互说明**:
  1. 客户端提交搜索关键词到API网关
  2. API网关转发请求到搜索控制器
  3. 搜索控制器调用搜索服务
  4. 搜索服务查询Elasticsearch获取搜索结果
  5. 如需补充商品详情，则调用商品服务从MySQL数据库获取
  6. 搜索结果返回给客户端

### 3. 订单创建流程

```
客户端 -> API网关 -> 订单控制器 -> 订单服务 -> 状态机引擎
                               -> 商品服务 -> 库存服务 -> 分布式锁服务 -> Redis
                               -> 用户服务
                               -> 优惠券服务
                               -> 事件总线 -> 通知服务
```

- **交互说明**:
  1. 客户端提交订单创建请求到API网关
  2. API网关转发请求到订单控制器
  3. 订单控制器调用订单服务创建订单
  4. 订单服务调用商品服务检查商品信息
  5. 商品服务通过库存服务锁定商品库存，使用分布式锁确保并发安全
  6. 订单服务调用用户服务获取用户信息和地址
  7. 订单服务调用优惠券服务应用优惠
  8. 订单服务通过状态机引擎初始化订单状态
  9. 订单创建成功后，通过事件总线发布订单创建事件
  10. 通知服务接收事件并发送订单创建通知
  11. 订单信息返回给客户端

### 4. 支付流程

```
客户端 -> API网关 -> 支付控制器 -> 支付服务 -> 支付接口适配器 -> 第三方支付API
                                            -> 订单服务
                                            -> 状态机引擎
```

- **交互说明**:
  1. 客户端提交支付请求到API网关
  2. API网关转发请求到支付控制器
  3. 支付控制器调用支付服务创建支付单
  4. 支付服务调用订单服务获取订单信息
  5. 支付服务根据支付方式选择对应的支付接口适配器
  6. 适配器调用第三方支付API创建支付单
  7. 支付结果通知通过webhook回调支付服务
  8. 支付服务通过状态机引擎更新订单状态
  9. 支付结果返回给客户端

### 5. 缓存交互流程

```
服务组件 -> 缓存适配器 -> Local Cache -> Redis集群
```

- **交互说明**:
  1. 服务组件通过统一的缓存适配器访问缓存
  2. 缓存适配器首先尝试从本地缓存获取数据
  3. 如本地缓存未命中，则从Redis集群获取数据
  4. 如Redis缓存也未命中，则从数据源获取数据并更新缓存
  5. 数据返回给服务组件

## 组件间通信方式

### 同步通信

- **REST API**：组件间主要使用HTTP/HTTPS协议的RESTful API进行同步通信
- **RPC**：部分核心组件之间使用更高性能的RPC通信

### 异步通信

- **事件驱动**：使用Spring Event事件总线进行系统内的异步通信
- **消息队列**：关键业务流程使用消息队列实现异步处理

## 组件依赖关系

### 核心依赖

- **订单服务** 依赖于 **商品服务**、**用户服务**、**支付服务**、**优惠券服务**
- **搜索服务** 依赖于 **商品服务**
- **购物车服务** 依赖于 **商品服务**、**用户服务**
- **支付服务** 依赖于 **订单服务**

### 基础设施依赖

所有业务服务都依赖于：
- 数据库服务
- 缓存服务
- 日志服务
- 配置服务

## 扩展点

系统设计了以下扩展点，允许在不修改核心代码的情况下添加新功能：

1. **支付渠道扩展点**：支持添加新的支付方式
2. **促销规则扩展点**：支持添加新的促销策略
3. **通知渠道扩展点**：支持添加新的消息通知方式
4. **数据导入/导出扩展点**：支持自定义数据导入导出格式

## 接口契约

组件间交互遵循以下契约原则：

1. **版本化API**：所有组件间接口都包含版本信息
2. **向后兼容**：新版接口保持对旧版客户端的兼容
3. **标准错误码**：统一的错误码和消息格式
4. **幂等设计**：关键操作支持幂等调用 