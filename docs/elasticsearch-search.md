# Elasticsearch æœç´¢åŠŸèƒ½æ–‡æ¡£

## æ¦‚è¿°

æœ¬é¡¹ç›®é›†æˆäº† Elasticsearch 8.11.0 ä½œä¸ºå•†å“æœç´¢å¼•æ“ï¼Œæä¾›é«˜æ€§èƒ½çš„å…¨æ–‡æœç´¢ã€æ™ºèƒ½æ¨èã€æœç´¢å»ºè®®ç­‰åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” æ ¸å¿ƒæœç´¢åŠŸèƒ½
- **å…¨æ–‡æœç´¢**ï¼šæ”¯æŒä¸­æ–‡åˆ†è¯ï¼Œæ™ºèƒ½åŒ¹é…å•†å“åç§°ã€æè¿°ã€åˆ†ç±»ã€å“ç‰Œç­‰å­—æ®µ
- **å¤šæ¡ä»¶ç­›é€‰**ï¼šæ”¯æŒåˆ†ç±»ã€å“ç‰Œã€ä»·æ ¼èŒƒå›´ç­‰å¤šç»´åº¦ç­›é€‰
- **æ™ºèƒ½æ’åº**ï¼šæ”¯æŒç›¸å…³æ€§ã€ä»·æ ¼ã€é”€é‡ã€è¯„åˆ†ã€æ—¶é—´ç­‰å¤šç§æ’åºæ–¹å¼
- **æœç´¢é«˜äº®**ï¼šæœç´¢ç»“æœå…³é”®è¯é«˜äº®æ˜¾ç¤º
- **åˆ†é¡µæŸ¥è¯¢**ï¼šé«˜æ•ˆçš„åˆ†é¡µæŸ¥è¯¢æ”¯æŒ

### ğŸ¯ æ™ºèƒ½æ¨è
- **æœç´¢å»ºè®®**ï¼šå®æ—¶æœç´¢å»ºè®®å’Œè‡ªåŠ¨è¡¥å…¨
- **çƒ­é—¨æœç´¢**ï¼šåŸºäºæœç´¢ç»Ÿè®¡çš„çƒ­é—¨å…³é”®è¯æ¨è
- **ç›¸ä¼¼å•†å“**ï¼šåŸºäºå•†å“å±æ€§çš„ç›¸ä¼¼å•†å“æ¨è
- **æœç´¢èšåˆ**ï¼šæä¾›åˆ†ç±»ã€å“ç‰Œã€ä»·æ ¼åŒºé—´ç­‰èšåˆç»Ÿè®¡

### ğŸ“Š æœç´¢åˆ†æ
- **æœç´¢ç»Ÿè®¡**ï¼šè®°å½•æœç´¢å…³é”®è¯ã€ç»“æœæ•°é‡ã€ç”¨æˆ·è¡Œä¸ºç­‰
- **çƒ­é—¨åˆ†æ**ï¼šåˆ†æçƒ­é—¨æœç´¢è¯å’Œæœç´¢è¶‹åŠ¿
- **æ€§èƒ½ç›‘æ§**ï¼šæœç´¢å“åº”æ—¶é—´å’ŒæˆåŠŸç‡ç›‘æ§
- **ç”¨æˆ·è¡Œä¸º**ï¼šæœç´¢ç‚¹å‡»ç‡å’Œè½¬åŒ–ç‡åˆ†æ

## æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯æœç´¢ç•Œé¢   â”‚â”€â”€â”€â”€â”‚   æœç´¢æ§åˆ¶å™¨     â”‚â”€â”€â”€â”€â”‚   æœç´¢æœåŠ¡å±‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Redisç¼“å­˜     â”‚â”€â”€â”€â”€â”‚  Elasticsearch  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   MySQLæ•°æ®åº“   â”‚â”€â”€â”€â”€â”‚   æœç´¢ç»Ÿè®¡æœåŠ¡   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµç¨‹
1. **ç´¢å¼•åŒæ­¥**ï¼šå•†å“æ•°æ®ä» MySQL åŒæ­¥åˆ° Elasticsearch
2. **æœç´¢è¯·æ±‚**ï¼šå‰ç«¯å‘é€æœç´¢è¯·æ±‚åˆ°åç«¯ API
3. **ç¼“å­˜æŸ¥è¯¢**ï¼šä¼˜å…ˆä» Redis ç¼“å­˜è·å–çƒ­é—¨æ•°æ®
4. **ESæŸ¥è¯¢**ï¼šæ‰§è¡Œ Elasticsearch å¤æ‚æŸ¥è¯¢
5. **ç»“æœå¤„ç†**ï¼šå¤„ç†æœç´¢ç»“æœå¹¶è¿”å›ç»™å‰ç«¯
6. **ç»Ÿè®¡è®°å½•**ï¼šå¼‚æ­¥è®°å½•æœç´¢ç»Ÿè®¡æ•°æ®

## API æ¥å£

### ç”¨æˆ·æœç´¢æ¥å£

#### 1. æœç´¢å•†å“
```http
GET /search/products
```

**å‚æ•°ï¼š**
- `keyword` (string, optional): æœç´¢å…³é”®è¯
- `categoryId` (integer, optional): åˆ†ç±»ID
- `brandId` (integer, optional): å“ç‰ŒID
- `minPrice` (decimal, optional): æœ€ä½ä»·æ ¼
- `maxPrice` (decimal, optional): æœ€é«˜ä»·æ ¼
- `sortBy` (string, optional): æ’åºå­—æ®µ (relevance, price, sales, rating, createTime)
- `sortOrder` (string, optional): æ’åºæ–¹å‘ (asc, desc)
- `page` (integer, optional): é¡µç ï¼Œä»0å¼€å§‹
- `size` (integer, optional): æ¯é¡µå¤§å°

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "content": [
      {
        "productId": 1,
        "productName": "ä¼˜è´¨å©´å„¿å¥¶ç²‰",
        "productPrice": 158.00,
        "productImage": "/images/product1.jpg",
        "salesCount": 1250,
        "rating": 4.8
      }
    ],
    "totalElements": 156,
    "totalPages": 16,
    "size": 10,
    "number": 0
  }
}
```

#### 2. è·å–æœç´¢å»ºè®®
```http
GET /search/suggestions?keyword=å¥¶&limit=10
```

#### 3. è·å–çƒ­é—¨æœç´¢è¯
```http
GET /search/hot-keywords?limit=10
```

#### 4. è·å–ç›¸ä¼¼å•†å“
```http
GET /search/similar/{productId}?limit=10
```

### ç®¡ç†å‘˜æ¥å£

#### 1. é‡å»ºæœç´¢ç´¢å¼•
```http
POST /admin/search/index/rebuild
```

#### 2. åŒæ­¥å•†å“åˆ°ç´¢å¼•
```http
POST /admin/search/sync/product/{productId}
```

#### 3. æ‰¹é‡åŒæ­¥å•†å“
```http
POST /admin/search/sync/products/batch
Content-Type: application/json

[1, 2, 3, 4, 5]
```

#### 4. æ£€æŸ¥ç´¢å¼•å¥åº·çŠ¶æ€
```http
GET /admin/search/health
```

## é…ç½®è¯´æ˜

### application.yml é…ç½®
```yaml
spring:
  data:
    elasticsearch:
      uris: localhost:9200
      connection-timeout: 5s
      socket-timeout: 30s
      username: # å¯é€‰
      password: # å¯é€‰

management:
  health:
    elasticsearch:
      enabled: true
```

### ç´¢å¼•é…ç½®
- **ç´¢å¼•åç§°**ï¼šproducts
- **åˆ†ç‰‡æ•°é‡**ï¼š1 (å•æœºéƒ¨ç½²)
- **å‰¯æœ¬æ•°é‡**ï¼š0 (å•æœºéƒ¨ç½²)
- **åˆ†è¯å™¨**ï¼šik_max_word (ç´¢å¼•), ik_smart (æœç´¢)

## éƒ¨ç½²æŒ‡å—

### 1. å®‰è£… Elasticsearch
```bash
# ä½¿ç”¨ Docker éƒ¨ç½²
docker run -d \
  --name elasticsearch \
  -p 9200:9200 \
  -p 9300:9300 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
  elasticsearch:8.11.0
```

### 2. å®‰è£… IK åˆ†è¯å™¨ (å¯é€‰)
```bash
# è¿›å…¥å®¹å™¨
docker exec -it elasticsearch bash

# å®‰è£… IK åˆ†è¯å™¨
./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v8.11.0/elasticsearch-analysis-ik-8.11.0.zip

# é‡å¯å®¹å™¨
docker restart elasticsearch
```

### 3. åˆå§‹åŒ–ç´¢å¼•
```bash
# å¯åŠ¨åº”ç”¨åï¼Œè°ƒç”¨ç®¡ç†æ¥å£åˆ›å»ºç´¢å¼•
curl -X POST "http://localhost:8080/admin/search/index/create"

# åŒæ­¥å•†å“æ•°æ®
curl -X POST "http://localhost:8080/admin/search/index/rebuild"
```

## æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ä¼˜åŒ–
- åˆç†è®¾ç½®åˆ†ç‰‡å’Œå‰¯æœ¬æ•°é‡
- å®šæœŸæ‰§è¡Œç´¢å¼•ä¼˜åŒ–æ“ä½œ
- ä½¿ç”¨ç´¢å¼•æ¨¡æ¿ç®¡ç†æ˜ å°„

### 2. æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤æŸ¥è¯¢
- åˆç†è®¾ç½®æŸ¥è¯¢è¶…æ—¶æ—¶é—´
- ä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶å’Œæ’åº

### 3. ç›‘æ§å‘Šè­¦
- ç›‘æ§ Elasticsearch é›†ç¾¤çŠ¶æ€
- ç›‘æ§æœç´¢å“åº”æ—¶é—´
- è®¾ç½®å¼‚å¸¸å‘Šè­¦æœºåˆ¶

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Elasticsearch è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ ES æœåŠ¡æ˜¯å¦å¯åŠ¨
   - éªŒè¯ç½‘ç»œè¿æ¥å’Œç«¯å£
   - æŸ¥çœ‹åº”ç”¨æ—¥å¿—é”™è¯¯ä¿¡æ¯

2. **æœç´¢ç»“æœä¸ºç©º**
   - æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
   - éªŒè¯å•†å“æ•°æ®æ˜¯å¦åŒæ­¥
   - æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶æ˜¯å¦æ­£ç¡®

3. **æœç´¢æ€§èƒ½æ…¢**
   - æ£€æŸ¥ ES é›†ç¾¤èµ„æºä½¿ç”¨æƒ…å†µ
   - ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
   - å¢åŠ ç¼“å­˜ç­–ç•¥

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/muying-mall.log | grep -i elasticsearch

# æŸ¥çœ‹ ES æ—¥å¿—
docker logs elasticsearch
```

## æ‰©å±•åŠŸèƒ½

### 1. æœç´¢æ¨èç®—æ³•
- åŸºäºç”¨æˆ·è¡Œä¸ºçš„ä¸ªæ€§åŒ–æ¨è
- ååŒè¿‡æ»¤æ¨èç®—æ³•
- æœºå™¨å­¦ä¹ æ¨¡å‹é›†æˆ

### 2. æœç´¢åˆ†æ
- æœç´¢æ¼æ–—åˆ†æ
- A/B æµ‹è¯•æ”¯æŒ
- å®æ—¶æœç´¢ç›‘æ§

### 3. å¤šè¯­è¨€æ”¯æŒ
- å›½é™…åŒ–æœç´¢
- å¤šè¯­è¨€åˆ†è¯å™¨
- è·¨è¯­è¨€æœç´¢

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤ Issueã€‚
