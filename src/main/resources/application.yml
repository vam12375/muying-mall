server:
  port: 8080
  servlet:
    context-path: /api
  # Tomcat高并发优化配置 - 支持5000-10000并发用户
  # 注意：启用虚拟线程后，Tomcat会自动使用虚拟线程处理请求
  # 传统线程池配置仍然保留，作为虚拟线程的底层支撑
  tomcat:
    relaxed-query-chars: '[,],{,},|'
    relaxed-path-chars: '[,],{,},|'
    max-http-form-post-size: 20MB
    # 线程池配置（虚拟线程模式下作为平台线程池的基础配置）
    threads:
      max: 800              # 最大工作线程数（虚拟线程模式下影响较小）
      min-spare: 200        # 最小空闲线程数（虚拟线程模式下影响较小）
    # 连接配置
    max-connections: 20000  # 最大连接数，从默认8192提升到20000
    accept-count: 1000      # 等待队列大小，从默认100提升到1000
    connection-timeout: 20000  # 连接超时时间(毫秒)
    keep-alive-timeout: 30000  # Keep-Alive超时时间(毫秒)
    max-keep-alive-requests: 200  # 单个连接最大Keep-Alive请求数
  # 响应压缩
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
    min-response-size: 1024

spring:
  application:
    name: muying-mall
  
  # 虚拟线程配置 (Java 21+ 特性)
  # 启用后，Spring Boot 会自动使用虚拟线程处理 Web 请求和异步任务
  # 优势：支持更高并发、减少线程管理开销、简化异步编程
  threads:
    virtual:
      enabled: true  # 启用虚拟线程支持
  
  # 引入私有配置文件
  profiles:
    include: private
    active: performance
  
  # 数据库配置
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/muying_mall?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    # 密码已移至application-private.yml
    # HikariCP连接池优化配置 - 针对高并发场景调优
    hikari:
      # 连接池最大连接数，从80提升到150以支持更高并发（优化：突破8600 TPS瓶颈）
      maximum-pool-size: 150
      # 最小空闲连接数，从20提升到50，减少连接创建开销（优化：保持足够的空闲连接）
      minimum-idle: 50
      # 连接超时时间（毫秒）
      connection-timeout: 30000
      # 空闲连接最大存活时间（10分钟）
      idle-timeout: 600000
      # 连接最大生命周期（30分钟，防止连接泄漏）
      max-lifetime: 1800000
      # 连接测试查询（验证连接有效性）
      connection-test-query: SELECT 1
      # 自动提交
      auto-commit: true
      # 连接池名称
      pool-name: MuyingMallHikariCP
      # 连接初始化SQL
      connection-init-sql: SET NAMES utf8mb4
      # 泄漏检测阈值（毫秒，0表示禁用）
      leak-detection-threshold: 60000
  
  # Redis配置  
  data:
    redis:
      host: localhost
      port: 6379
      # 密码已移至application-private.yml
      database: 0
      # Redis连接池配置 - 优化：扩大连接池以支持高并发场景（优化：突破8600 TPS瓶颈）
      lettuce:
        pool:
          max-active: 100      # 最大连接数，从64提升到100以支持更高并发
          max-idle: 50         # 最大空闲连接数，从32提升到50
          min-idle: 25         # 最小空闲连接数，从16提升到25，保持足够的可用连接
          max-wait: 3000ms     # 连接池最大阻塞等待时间，从1000ms提升到3000ms
          time-between-eviction-runs: 60000ms # 空闲连接检测周期
      timeout: 5000ms          # 连接超时时间，从3000ms提升到5000ms
      # Redis客户端配置
      client-name: muying-mall # 客户端名称，便于监控识别
      connect-timeout: 5000ms  # 连接超时时间，从3000ms提升到5000ms
      # Redis高级配置
      client-type: lettuce     # 使用lettuce客户端
  
  # Session配置
  session:
    store-type: redis
    timeout: 604800s  # 7天 (7*24*60*60=604800秒)
    redis:
      namespace: muying:session
      flush-mode: on_save  # 确保会话变更立即写入Redis
      
  # RabbitMQ配置
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
    virtual-host: /
    connection-timeout: 15000
    # 性能优化：使用simple异步确认模式，避免同步阻塞
    # publisher-confirm-type: correlated
    publisher-confirm-type: simple
    publisher-returns: true
    template:
      mandatory: true
      retry:
        enabled: true
        initial-interval: 1000
        max-attempts: 3
        max-interval: 10000
        multiplier: 2
    listener:
      simple:
        acknowledge-mode: auto  # 优化：改为自动确认，减少手动ACK开销
        concurrency: 10  # 优化：提升并发消费者数量到10（2000并发场景）
        max-concurrency: 20  # 优化：最大并发提升到20
        prefetch: 20  # 优化：预取20条消息，减少网络往返次数
        # 启用自动启动监听器，支持RabbitMQ消息消费
        auto-startup: true
        missing-queues-fatal: false  # 队列不存在时不抛出致命异常
        retry:
          enabled: true
          initial-interval: 5000  # 增加初始重试间隔到5秒
          max-attempts: 3  # 最多重试3次
          max-interval: 30000  # 最大间隔30秒
          multiplier: 2
      
  # Elasticsearch配置
  elasticsearch:
    uris: localhost:9200 # Elasticsearch访问地址
    connection-timeout: 15s # 连接超时时间（优化：从10s提升到15s，解决索引更新超时）
    socket-timeout: 90s # 套接字超时时间（优化：从60s提升到90s，确保索引操作有足够时间）
    username: # 如果有认证信息，可在此处配置
    password: # 如果有认证信息，可在此处配置
    # 连接池配置 (高并发优化)
    pool:
      max-total: 100          # 最大连接数
      max-per-route: 50       # 每个路由最大连接数
      connection-timeout: 15000  # 连接超时(毫秒) - 优化：从10s提升到15s
      socket-timeout: 90000     # Socket超时(毫秒) - 优化：从30s提升到90s，解决索引更新超时

# Elasticsearch扩展配置
elasticsearch:
  # 批量操作配置
  bulk:
    batch-size: 200           # 批量操作每批大小
    concurrent-requests: 3    # 并发请求数
  # 搜索配置
  search:
    cache-ttl: 600            # 搜索结果缓存时间(秒) - 优化：从300秒提升到10分钟
    max-result-window: 10000  # 最大结果窗口
    default-size: 20          # 默认返回数量
  # 缓存预热配置
  warmup:
    enabled: true             # 是否启用缓存预热
    hot-keywords-count: 20    # 预热的热门关键词数量
  # 索引配置
  index:
    number-of-shards: 3       # 分片数量 - 优化：根据数据量调整
    number-of-replicas: 1     # 副本数量
    refresh-interval: 30s     # 刷新间隔 - 优化：从1s提升到30s，减少刷新开销
    max-result-window: 10000  # 最大结果窗口

# 异步任务线程池配置（虚拟线程模式下已废弃）
# 注意：项目已迁移到虚拟线程，以下配置不再使用
# 虚拟线程自动管理，无需手动配置线程池参数
# async:
#   executor:
#     core-pool-size: 0         # 已废弃
#     max-pool-size: 0          # 已废弃
#     queue-capacity: 500       # 已废弃
#     keep-alive-seconds: 60    # 已废弃

# 健康检查配置
management:
  health:
    elasticsearch:
      enabled: false # 禁用Elasticsearch健康检查，避免启动失败
    rabbitmq:
      enabled: false # 禁用RabbitMQ健康检查，避免日志刷屏
  endpoint:
    health:
      show-details: always # 显示详细健康信息
      show-components: always # 显示所有组件健康状态
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,rabbitmq # 暴露健康检查和监控端点
  metrics:
    export:
      prometheus:
        enabled: true # 启用Prometheus指标导出
    tags:
      application: muying-mall # 添加应用标签
      
# Redis自定义配置
redis:
  # 缓存淘汰策略配置
  config:
    # 设置maxmemory-policy为volatile-lru，只淘汰设置了过期时间的key
    maxmemory-policy: volatile-lru
    # Redis内存限制，建议设置为可用内存的75%
    maxmemory: 1gb
    # 键空间通知配置，启用过期和驱逐事件通知
    notify-keyspace-events: Ex
  # 缓存统计配置
  stats:
    # 是否启用缓存统计
    enabled: true
    # 统计采样率（1-100）
    sample-rate: 10
  # 高级特性配置
  features:
    # 是否启用批量操作Pipeline
    pipeline-enabled: true
    # 是否启用Lua脚本缓存
    script-cache-enabled: true
    # 是否启用分布式锁
    lock-enabled: true

# MyBatis-Plus配置
mybatis-plus:
  mapper-locations: classpath:/mapper/**/*.xml
  type-aliases-package: com.muyingmall.entity
  configuration:
    map-underscore-to-camel-case: true
    # 优化：生产/压测环境关闭SQL日志输出，减少IO开销
    # 开发调试时可改为 org.apache.ibatis.logging.stdout.StdOutImpl
    log-impl: org.apache.ibatis.logging.nologging.NoLoggingImpl
    database-id: mysql
    # 优化：启用缓存和延迟加载
    cache-enabled: true
    lazy-loading-enabled: true
    default-executor-type: reuse
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: is_deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
      db-type: mysql

# Knife4j API文档配置
# 访问地址: http://localhost:8080/api/doc.html
springdoc:
  api-docs:
    path: /v3/api-docs
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
  packages-to-scan: com.muyingmall.controller

# Knife4j 增强配置
knife4j:
  enable: true
  setting:
    language: zh_cn
    enable-swagger-models: true
    swagger-model-name: 实体类列表
    enable-document-manage: true
    enable-version: false
    enable-request-cache: true
    enable-host: false
    enable-home-custom: false
    enable-search: true
    enable-footer-custom: true
    footer-custom-content: 母婴商城 API 文档 v1.2.0
    enable-dynamic-parameter: true
    enable-debug: true
    enable-open-api: true
    enable-group: true
  cors: true
  production: false
  basic:
    enable: false

# CORS配置
cors:
  allowed-origins: http://localhost:5173,http://localhost:3000,http://localhost:8081,http://localhost:4000,https://muying-admin.netlify.app
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS
  allowed-headers: Authorization,Content-Type,X-Requested-With,Accept,Origin,Access-Control-Request-Method,Access-Control-Request-Headers,X-CSRF-Token
  allow-credentials: true
  max-age: 3600
    
# 支付宝配置 - 敏感信息已移至application-private.yml
alipay:
  # app-id已移至application-private.yml
  # private-key已移至application-private.yml
  # public-key已移至application-private.yml
  gateway-url: https://openapi-sandbox.dl.alipaydev.com/gateway.do  # 沙箱环境网关，正式环境需修改
  return-url: http://localhost:8080/api/payment/alipay/return #钱包充值成功后的跳转地址
  notify-url: http://localhost:8080/api/payment/alipay/notify #钱包充值异步回调地址
  refund-notify-url: http://localhost:8080/api/payment/alipay/refund/notify #退款异步回调地址
  # 订单支付回调地址（如果需要区分）
  wellet-return-url: http://localhost:8080/api/payment/alipay/return #订单支付成功后的跳转地址
  wellet-notify-url: http://localhost:8080/api/payment/alipay/notify #订单支付异步回调地址

# 微信支付配置 - 敏感信息已移至application-private.yml
wechat:
  pay:
    # app-id已移至application-private.yml
    # mch-id已移至application-private.yml
    # mch-serial-number已移至application-private.yml
    private-key-path: classpath:cert/apiclient_key.pem
    # api-v3-key已移至application-private.yml
    notify-url: http://localhost:8080/api/payment/wechat/notify
    
# 日志配置 - 优化：压测/生产环境降低日志级别，减少IO开销
logging:
  level:
    root: WARN
    com.muyingmall: INFO
    org.springframework.web: WARN
    org.springframework.security: WARN
    org.springframework.data.redis: WARN
    org.springframework.data.elasticsearch: WARN
    org.springframework.amqp: ERROR
    org.springframework.amqp.rabbit.listener: ERROR
    org.springframework.amqp.rabbit.connection: ERROR
    com.baomidou.mybatisplus: WARN
    com.zaxxer.hikari: WARN

# 前端应用地址 (用于支付回调重定向)
frontend:
  url: http://localhost:5173

# JWT配置 - 敏感信息已移至application-private.yml
jwt:
  # secret已移至application-private.yml
  expiration: 86400 # 单位：秒 (这里是24小时)

# 缓存配置
cache:
  # 全局缓存设置
  global:
    # 是否启用缓存
    enabled: true
    # 默认过期时间（秒）
    default-ttl: 3600
  # 二级缓存设置
  second-level:
    # 是否启用本地缓存作为二级缓存
    enabled: false
    # 本地缓存最大大小
    max-size: 1000
    # 本地缓存过期时间（秒）
    ttl: 60

# RabbitMQ自定义配置
rabbitmq:
  enabled: true  # 是否启用RabbitMQ功能
  fallback-to-sync: true  # RabbitMQ不可用时是否回退到同步处理
  # 错误处理配置
  error-handling:
    max-retry-attempts: 3  # 最大重试次数
    retry-interval: 1000  # 重试间隔（毫秒）
    dead-letter-enabled: true  # 是否启用死信队列
    alert-enabled: true  # 是否启用告警
    connection-timeout: 15000  # 连接超时时间（毫秒）
    send-timeout: 5000  # 消息发送超时时间（毫秒）
  # 监控配置
  monitoring:
    enabled: true  # 是否启用监控
    health-check-interval: 30000  # 健康检查间隔（毫秒）
    metrics-collection-enabled: true  # 是否启用指标收集
    stats-retention-days: 7  # 统计数据保留天数
    connection-status-enabled: true  # 是否启用连接状态监控
    queue-length-alert-threshold: 1000  # 队列长度告警阈值
  # 性能配置（优化：针对2000并发场景调整）
  performance:
    concurrent-consumers: 10  # 消费者并发数（优化：从5提升到10）
    max-concurrent-consumers: 20  # 最大消费者并发数（优化：从10提升到20）
    prefetch-count: 20  # 预取数量（优化：从1提升到20，减少网络往返）
    batch-size: 100  # 批量大小
    batch-processing-enabled: false  # 是否启用批量处理
    batch-timeout: 1000  # 批量处理超时时间（毫秒）