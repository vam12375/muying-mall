# 性能优化配置
# Source: 性能优化 - 数据库和连接池配置
# 优化目标：降低商品浏览和详情接口的错误率

spring:
  # 数据源配置优化 - 针对高并发场景调优
  datasource:
    hikari:
      # 连接池大小 - 增大以支持更高并发
      minimum-idle: 20
      maximum-pool-size: 100
      # 连接超时 - 适当增加避免高峰期超时
      connection-timeout: 30000
      # 空闲超时
      idle-timeout: 300000
      # 最大生命周期
      max-lifetime: 1200000
      # 连接测试查询
      connection-test-query: SELECT 1
      # 自动提交
      auto-commit: true
      # 连接池名称
      pool-name: HikariPool-Performance
      # 泄漏检测阈值
      leak-detection-threshold: 60000
      # 验证超时
      validation-timeout: 5000

  # Redis配置优化 - 增大连接池支持高并发
  data:
    redis:
      # 连接池配置
      lettuce:
        pool:
          max-active: 50
          max-idle: 20
          min-idle: 10
          max-wait: 5000ms
        # 关闭超时
        shutdown-timeout: 100ms
      # 超时配置
      timeout: 5000ms
      # 连接超时
      connect-timeout: 5000ms

  # JPA配置优化
  jpa:
    properties:
      hibernate:
        # 批量操作大小
        jdbc:
          batch_size: 50
          fetch_size: 50
        # 二级缓存
        cache:
          use_second_level_cache: true
          use_query_cache: true
          region:
            factory_class: org.hibernate.cache.jcache.JCacheRegionFactory
        # SQL格式化（生产环境关闭）
        format_sql: false
        # 显示SQL（生产环境关闭）
        show_sql: false
        # 统计信息
        generate_statistics: false

# MyBatis Plus配置优化
mybatis-plus:
  configuration:
    # 缓存
    cache-enabled: true
    # 懒加载
    lazy-loading-enabled: true
    aggressive-lazy-loading: false
    # 多结果集
    multiple-result-sets-enabled: true
    # 列名映射
    use-column-label: true
    # 自动映射
    auto-mapping-behavior: partial
    # 默认执行器类型
    default-executor-type: reuse
    # 超时时间
    default-statement-timeout: 25000
    # 日志实现（生产环境使用NO_LOGGING）
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
  global-config:
    # 刷新Mapper
    refresh: false
    db-config:
      # 逻辑删除
      logic-delete-value: 1
      logic-not-delete-value: 0

# 服务器配置优化 - 针对高并发场景调优
server:
  # Tomcat配置
  tomcat:
    threads:
      # 最大线程数 - 增大以支持更高并发
      max: 400
      # 最小空闲线程数 - 增大以减少线程创建开销
      min-spare: 50
    # 最大连接数 - 增大以支持更多并发连接
    max-connections: 20000
    # 接受队列大小 - 增大以缓冲突发请求
    accept-count: 500
    # 连接超时
    connection-timeout: 20000
    # 保持连接超时
    keep-alive-timeout: 30000
  # 压缩
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css
    min-response-size: 1024

# 日志配置（生产环境）
logging:
  level:
    root: INFO
    com.muyingmall: INFO
    org.springframework.web: WARN
    org.hibernate: WARN
    com.baomidou.mybatisplus: WARN
