# 性能优化配置
# Source: 性能优化 - 数据库和连接池配置
# 优化目标：降低商品浏览和详情接口的错误率（目标：错误率 < 1%）

spring:
  # 数据源配置优化 - 针对虚拟线程环境调优
  # 虚拟线程会自动排队等待连接，无需过大的连接池
  datasource:
    hikari:
      # 连接池大小 - 虚拟线程模式下适度降低（从600降至200）
      minimum-idle: 50
      maximum-pool-size: 200
      # 连接超时 - 高并发下适当延长，避免获取连接超时
      connection-timeout: 90000
      # 空闲超时 - 10分钟，及时释放空闲连接
      idle-timeout: 600000
      # 最大生命周期 - 30分钟，防止连接老化
      max-lifetime: 1800000
      # 连接测试查询
      connection-test-query: SELECT 1
      # 自动提交
      auto-commit: true
      # 连接池名称
      pool-name: HikariPool-Performance
      # 泄漏检测阈值 - 2分钟
      leak-detection-threshold: 120000
      # 验证超时
      validation-timeout: 5000
      # 初始化失败超时 - 快速失败
      initialization-fail-timeout: 30000
      # 注册MBean用于监控
      register-mbeans: true

  # Redis配置优化 - 虚拟线程环境下适度降低连接池
  # 虚拟线程会自动管理并发，无需过大的连接池
  data:
    redis:
      # 连接池配置 - 虚拟线程模式下优化（从512降至200）
      lettuce:
        pool:
          max-active: 200       # 最大连接数（从512降低）
          max-idle: 100         # 最大空闲连接数（从256降低）
          min-idle: 50          # 最小空闲连接数（从128降低）
          max-wait: 15000ms     # 延长等待时间，避免高峰期获取连接失败
        # 关闭超时
        shutdown-timeout: 200ms
      # 超时配置 - 适当延长避免超时
      timeout: 15000ms          # 从10000ms提升到15000ms
      # 连接超时
      connect-timeout: 15000ms  # 从10000ms提升到15000ms

  # JPA配置优化
  jpa:
    properties:
      hibernate:
        # 批量操作大小
        jdbc:
          batch_size: 50
          fetch_size: 50
        # 二级缓存
        cache:
          use_second_level_cache: true
          use_query_cache: true
          region:
            factory_class: org.hibernate.cache.jcache.JCacheRegionFactory
        # SQL格式化（生产环境关闭）
        format_sql: false
        # 显示SQL（生产环境关闭）
        show_sql: false
        # 统计信息
        generate_statistics: false

# MyBatis Plus配置优化
mybatis-plus:
  configuration:
    # 缓存 - 启用一级缓存
    cache-enabled: true
    # 懒加载 - 启用延迟加载减少不必要查询
    lazy-loading-enabled: true
    aggressive-lazy-loading: false
    # 多结果集
    multiple-result-sets-enabled: true
    # 列名映射
    use-column-label: true
    # 自动映射
    auto-mapping-behavior: partial
    # 默认执行器类型 - REUSE复用Statement
    default-executor-type: reuse
    # 超时时间（单位：秒）- 修正：原25000是错误值
    default-statement-timeout: 30
    # 日志实现 - 压测/生产环境关闭SQL日志输出
    log-impl: org.apache.ibatis.logging.nologging.NoLoggingImpl
    # 本地缓存作用域 - SESSION级别
    local-cache-scope: session
    # 调用setter时即使值为null也调用
    call-setters-on-nulls: true
  global-config:
    # 刷新Mapper - 生产环境关闭
    refresh: false
    # 关闭Banner
    banner: false
    db-config:
      # 逻辑删除
      logic-delete-value: 1
      logic-not-delete-value: 0

# 服务器配置优化 - 针对5000-10000并发用户场景调优
server:
  # Tomcat配置 - 极限性能模式
  tomcat:
    threads:
      # 最大线程数 - 与数据库连接池比例 2:1
      max: 800
      # 最小空闲线程数 - 预热线程池，减少线程创建开销
      min-spare: 200
    # 最大连接数 - 支持大量并发连接
    max-connections: 30000
    # 接受队列大小 - 缓冲突发请求，避免连接被拒绝
    accept-count: 3000
    # 连接超时 - 适当延长避免超时
    connection-timeout: 60000
    # 保持连接超时
    keep-alive-timeout: 60000
    # 单个连接最大Keep-Alive请求数
    max-keep-alive-requests: 1000
    # 处理器缓存大小
    processor-cache: 500
    # URI编码
    uri-encoding: UTF-8
  # 压缩 - 减少网络传输
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css
    min-response-size: 512

# 日志配置（压测/生产环境 - 减少日志输出提升性能）
logging:
  level:
    root: WARN
    com.muyingmall: INFO
    org.springframework.web: WARN
    org.hibernate: WARN
    com.baomidou.mybatisplus: WARN
    com.zaxxer.hikari: WARN
    io.lettuce: WARN

# 自定义性能配置
performance:
  # 缓存预热配置
  cache-warmup:
    enabled: true
    # 启动时预热热门商品缓存
    products: true
    # 启动时预热分类缓存
    categories: true
  # 查询优化配置
  query:
    # 分页查询最大条数限制
    max-page-size: 100
    # 默认分页大小
    default-page-size: 20
  # 限流配置
  rate-limit:
    # 是否启用限流
    enabled: true
    # 每秒最大请求数
    requests-per-second: 2000

# RabbitMQ自定义配置 - 性能优化模式
rabbitmq:
  enabled: true  # 显式启用RabbitMQ功能
  fallback-to-sync: true  # RabbitMQ不可用时回退到同步处理
  # 错误处理配置
  error-handling:
    max-retry-attempts: 3  # 最大重试次数
    retry-interval: 1000  # 重试间隔（毫秒）
    dead-letter-enabled: true  # 是否启用死信队列
    alert-enabled: true  # 是否启用告警
    connection-timeout: 15000  # 连接超时时间（毫秒）
    send-timeout: 5000  # 消息发送超时时间（毫秒）
  # 监控配置
  monitoring:
    enabled: true  # 是否启用监控
    health-check-interval: 30000  # 健康检查间隔（毫秒）
    metrics-collection-enabled: true  # 是否启用指标收集
    stats-retention-days: 7  # 统计数据保留天数
    connection-status-enabled: true  # 是否启用连接状态监控
    queue-length-alert-threshold: 1000  # 队列长度告警阈值
  # 性能配置
  performance:
    concurrent-consumers: 5  # 消费者并发数
    max-concurrent-consumers: 10  # 最大消费者并发数
    prefetch-count: 1  # 预取数量
    batch-size: 100  # 批量大小
    batch-processing-enabled: false  # 是否启用批量处理
    batch-timeout: 1000  # 批量处理超时时间（毫秒）
